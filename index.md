На данной странице находится описание по работе с метрикой сервиса [Qiberty](https://qiberty.com). Она работает в схожей манере с Google.Analytics и Яндекс.Метрикой, но имеет свои отличия. На данный момент, использование возможно в 2 вариантах:
1. [Через JS-скрипт](#use-js)
2. [Через REST API](#use-rest)

Также возможно [комбинирование](#use-js-rest) этих подходов.

## <a name="start"></a> Начало работы
Для начала работы вам необходимо будет создать счетчик и получить его идентификатор. В дальнейшем этот процесс будет автоматизирован, но на данный момент, для того, чтобы получить его, вам необходимо связаться с нами, например, посредством электронной почты. Для этого нужно написать письмо на [support@qiberty.com](mailto:support@qiberty.com), с темой "Получение идентификатора для метрики". В этом письме надо передать слудующую информацию
- Логин в Qiberty (если такого нет, передать email для регистрации)
- Основной сайт, на который будет установлена метрика
- Список целей для вашего сайта (например, "registration", "purchase_card", или другие)
  - Название должно быть на латинице, без пробелов
 
После проверки и обработки переданной информации, вам будет выслан ваш идентификатор метрики.

## <a name="use-js"></a>Использование через JS-скрипт
Для работы с метрикой Qiberty можно использовать реализованный нами JS-скрипт. Ниже приводится описание того, как реализовать этот вариант на вашем сайте.

### <a name="use-js-visit"></a>1. Размещение счетчика Qiberty на сайте
Первым делом необходимо разместить данный JS код в блоке `<head>...</head>` на всех страницах вашего сайта:
```js
<!-- Qiberty counter -->
<script type="text/javascript" async>
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = "//metrics.qiberty.com/js/counter.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
  window.onload = function() {
    window.qiberty_visit(counter_id);
  }
</script>
<!-- /Qiberty counter -->
```
Данный код делает 2 вещи
1. Он подключает методы из реализованного JS-скрипта, и теперь вы можете вызывать их в коде страницы.
2. При посещении страницы, он регистрирует визит и регистирует его в системе метрик Qiberty.

**Заметьте,** что вместо `counter_id` вам необходимо подставить ваш идентификатор счетчика, полученный при его [создании](#start).

### 2. Регистрация цели
Следующим шагом необходимо добавить регистрацию цели на необходимые вам события. Делается это посредством вызова функции `qiberty_target`:
```js
qiberty_target(target, counter_id[, client_id, factor, params]);
```
Здесь
- `target` - *(обязательный параметр)* название вашей цели. 
  - **Важно:** перед тем, как испльзовать цель, вам необходимо ее [зарегистрировать](#start)
- `counter_id` - *(обязательный параметр)* идентификатор вашего счетчика
- `client_id` - *(необязательный параметр)* идентификатор пользователя в вашей системе
  - Данную опцию можно использовать для того, чтобы легко сопоставлять пользователей в вашей системе с целями в нашей системе метрик. 
- `factor` - *(необязательный параметр)* вес цели
  - Сюда вы можете передавать, например, стоимость покупки, в формате `100.00`. Значение по умолчанию - 1.
- `params` - *(необязательный параметр)* словарь дополнительных параметров
  - Если вы хотите добавить дополнительные параметры к цели, например, название купленного товара или допольнительную информацию для регистрации, вы можете передать ее здесь. Ключ словаря должен быть на латинице без пробелов, значение в словаре может иметь вид произвольной строки, длиной не более 512 символов. Выглядеть это может так: `{"name":"Холодильник Урал","color":"Синий"}`

### 3. Проверка работоспособности
После того, как все шаги реализованы, необходимо проверить, что запросы не возвращают ответы с кодами `4хх` или `5хх`, а также проверить, что запросы успешно доходят до системы метрик Qiberty. В дальнейшем этот процесс будет автоматизирован, но на данный момент сделать это можно только связавшись с нами, например, через электронную почту [support@qiberty.com](mailto:support@qiberty.com)

## <a name="use-rest"></a>Использование через REST API
Если по каким-то причинам вам не подходит вариант использования через JS-скрипт, возможен также вариант подключения метрики через REST API. Дефолтный путь для вызова методов: `https://metrics.qiberty.com/v1`.
### <a name="use-rest-visit"></a>1. Регистрация посещения сайта
При визите сайта посетителем, необходимо вызывать метод регистрации посещения. 
```
POST /visit?counter_id=(counter_id)[&visitor_id=(visitor_id)&sub_id=(sub_id)]
```
Здесь
- `counter_id` - *(обязательный параметр)* идентификатор вашего счетчика
- `visitor_id` - *(необязательный параметр)* идентификатор посетителя в системе Qiberty
  - Используется, если это не первый визит посетителя. Необходимо передавать, если передача идентификатора пользователя через cookie невозможна (см. ниже). Альтернативно можно использовать параметр `sub_id`, если уже было произведено связывание (см. метод [bind](#use-rest-bind))
- `sub_id` - *(необязательный параметр)* идентификатор посетителя в вашей системе
  - Альтернатива параметру `visitor_id`. Используется, если это не первый визит посетителя и у него уже есть внутренний идентификатор в вашей системе. **Важно:** если одновременно передать параметры `visitor_id` и `sub_id`, то автоматиески произойдет операция связывания (см. метод [bind](#use-rest-bind))

В метод можно также передавать тело запроса, в котором будут содержаться дополнительные параметры посещения, например, вариант лендинга при A/B-тестировании. Ключ словаря должен быть на латинице без пробелов, значение в словаре может иметь вид произвольной строки, длиной не более 512 символов. Формат тела запроса представляет собой словарь:
```json
{
  "landing":"a",
  "some_other_param":"some_other_value"
}
```
При успешном выполнении метода будет возвращен словать с идентификатором посетителя в ситсеме Qiberty:
```json
{
  "visitor_id":"abc123456789"
}
```
Кроме того, в заголовке ответа возвращается запрос на установку cookie для пользователя:
```
Set-Cookie:_qib_id_=abc123456789;Version=1;Domain=.qiberty.com;Path=/;Max-Age=2147483647
```
Если, по каким-то причинам, cookie не может установиться сама, вам необходимо сделать это самостоятельно по образцу выше. После успешной установки cookie информация о посетителе автоматически будет передаваться через запросы. Такой подход избавляет вас от необходимости хранить идентификаторы посетителей на своей стороне. Если по каким-либо причинам cookie не может быть сохранена, вы можете хранить эти данные у себя и передавать их через параметры `visitor_id` или `sub_id` (описание выше).

**Важно:** рекомендуется вызывать этот метод при любых визитах на сайт (не только для визитах через контекстную рекламу) для более полной статистики.

### <a name="use-rest-target"></a>2. Регистрация цели
При выполнении цели необходимо вызывать следующий метод:
```
PUT /target?target=(target)&counter_id=(counter_id)[&visitor_id=(visitor_id)&sub_id=(sub_id)&factor=(factor)]
```
Здесь
- `target` - *(обязательный параметр)* название вашей цели. 
  - **Важно:** перед тем, как испльзовать цель, вам необходимо ее [зарегистрировать](#start)
- `counter_id` - *(обязательный параметр)* идентификатор вашего счетчика
- `visitor_id` - *(необязательный параметр)* идентификатор посетителя
  - Необходимо передавать, если передача идентификатора пользователя через cookie невозможна. Альтернативно можно передавать параметр `sub_id`, если уже было произведено связывание (см. метод [bind](#use-rest-bind)).
- `sub_id` - *(необязательный параметр)* идентификатор пользователя в вашей системе
  - Данную опцию можно использовать для того, чтобы легко сопоставлять пользователей в вашей системе с целями в нашей системе метрик. Для того, чтобы использовать этот параметр, необходимо вызвать метод связывания [bind](#use-rest-bind) или, альтернативно, одновременно передать идентификатор посетителя (через параметр `visitor_id` или через cookie) и параметр `sub_id`. Тогда операция связывания произойдет автоматически.
- `factor` - *(необязательный параметр)* вес цели
  - Сюда вы можете передавать, например, стоимость покупки. Формат - десятичное число, например, `100.00`. Значение по умолчанию - 1.
  
В метод можно также перевать тело запроса, в котором будут содержаться дополнительные параметры посещения, например, название купленного товара или допольнительную информацию для регистрации. Ключ словаря должен быть на латинице без пробелов, значение в словаре может иметь вид произвольной строки, длиной не более 512 символов. Формат тела запроса представляет собой словарь:
```json
{
  "name":"Холодильник Урал",
  "color":"Синий",
  "some_other_param":"some_other_value"
}
```

### <a name="use-rest-bind"></a>3. Операция связывания
Этот метод позволит легко сопоставлять пользователей в вашей системе с посетителями в Qiberty и облегчит аналитику. Для того, чтобы связать посетителя в системе Qiberty и пользователя в вашей системе, можно использовать метод связывания:
```
PATCH /bind?counter_id=(counter_id)&sub_id=(sub_id)[&visitor_id=(visitor_id)]
```
Здесь
- `counter_id` - *(обязательный параметр)* идентификатор вашего счетчика
- `sub_id` - *(обязательный параметр)* идентификатор посетителя в вашей системе
- `visitor_id` - *(необязательный параметр)* идентификатор посетителя в системе Qiberty
  - Необходимо передавать, если передача идентификатора пользователя через cookie невозможна (см. подробности про cookie в методе [visit](#use-rest-visit)). 
   
## <a name="use-js-rest"></a>Совместное использование JS-скрипта и REST API
В большинстве случаев использование JS-скрипта достаточно для успешной работы метрики. Тем не менее, если цель невозможно вызвать через JS-код (например, когда цель - это пополнение баланса), возможно комбинировать два подхода. Для этого необходимо разместить скрипт на сайт как описано в пункте [Размещение счетчика Qiberty на сайте](#use-js-visit), а цель вызывать через REST API на стороне сервера, как описано в пункте [Регистрация цели](#use-rest-target). В таком случае никаких проблем со сбором статистики быть не должно.

## Решение проблем
Если вы испытываете трудности при поддержке метрики Qiberty, то вы можете связаться с нами, например, через электронную почту [support@qiberty.com](mailto:support@qiberty.com).

